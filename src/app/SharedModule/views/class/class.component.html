<!-- Header sticky con información principal -->
<div class="class-header" [class.mobile]="false">
  <div class="header-content">
    <!-- Título principal -->
    <div class="title-section">
      <h1 class="class-title">
        {{ i18nService.translate('class.title', { 
          course: classData()?.course_id || 'Clase', 
          tutorName: classData()?.tutorData?.full_name || classData()?.tutorUser?.email || 'Tutor' 
        }) }}
      </h1>
    </div>

    <!-- Badge de estado -->
    <div class="status-section">
      <mat-chip-set>
        <mat-chip [color]="statusColor()" selected>
          <mat-icon>{{ getStatusIcon() }}</mat-icon>
          {{ i18nService.translate('class.status.' + classData()?.status) }}
        </mat-chip>
      </mat-chip-set>
    </div>

    <!-- Fecha y hora -->
    <div class="datetime-section">
      <div class="datetime-display">
        <mat-icon>schedule</mat-icon>
        <span class="datetime-text">{{ formatDateTime(getClassDateTime()) }}</span>
        <button mat-icon-button [matTooltip]="i18nService.translate('class.info.showInMyTime')">
          <mat-icon>public</mat-icon>
        </button>
      </div>
    </div>

    <!-- Acciones principales -->
    <div class="actions-section">
      <button 
        mat-raised-button 
        color="primary" 
        *ngIf="canEdit()"
        (click)="editClass()">
        <mat-icon>edit</mat-icon>
        <span translateText="class.actions.edit"></span>
      </button>

      <button 
        mat-raised-button 
        color="accent" 
        *ngIf="canJoinClass()"
        (click)="joinClass()">
        <mat-icon>video_call</mat-icon>
        <span translateText="class.actions.join"></span>
      </button>

      <button 
        mat-raised-button 
        color="primary" 
        *ngIf="canConfirmAttendance()"
        (click)="confirmAttendance()">
        <mat-icon>check_circle</mat-icon>
        <span translateText="class.actions.confirmAttendance"></span>
      </button>

      <!-- Menú de más acciones -->
      <button mat-icon-button [matMenuTriggerFor]="actionsMenu">
        <mat-icon>more_vert</mat-icon>
      </button>
      <mat-menu #actionsMenu="matMenu">
        <button mat-menu-item (click)="rescheduleClass()">
          <mat-icon>schedule</mat-icon>
          <span translateText="class.actions.reschedule"></span>
        </button>
        <button mat-menu-item (click)="cancelClass()">
          <mat-icon>cancel</mat-icon>
          <span translateText="class.actions.cancel"></span>
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="setReminder()">
          <mat-icon>notifications</mat-icon>
          <span translateText="class.actions.reminder"></span>
        </button>
        <button mat-menu-item (click)="reportIncident()">
          <mat-icon>flag</mat-icon>
          <span translateText="class.actions.report"></span>
        </button>
      </mat-menu>

      <!-- Botón de cambio de idioma -->
      <button mat-icon-button (click)="toggleLanguage()" [matTooltip]="i18nService.translate('layout.changeLanguage')">
        <mat-icon>translate</mat-icon>
      </button>
    </div>
  </div>
</div>

<!-- Contenido principal en estado de carga -->
<div *ngIf="isLoading()" class="loading-container">
  <mat-spinner diameter="50"></mat-spinner>
  <p translateText="common.loading"></p>
</div>

<!-- Contenido principal en estado de error -->
<div *ngIf="error() && !isLoading()" class="error-container">
  <mat-icon>error_outline</mat-icon>
  <h2>{{ i18nService.translate('common.error') }}</h2>
  <p>{{ error() }}</p>
  <button mat-raised-button color="primary" (click)="loadClassData()">
    <mat-icon>refresh</mat-icon>
    <span translateText="common.retry"></span>
  </button>
</div>

<!-- Layout principal de dos columnas -->
<div *ngIf="classData() && !isLoading() && !error()" class="class-content">
  
  <!-- Columna principal (izquierda/arriba en mobile) -->
  <div class="main-column">
    
    <!-- Card de detalles de la clase -->
    <mat-card class="details-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>info</mat-icon>
          <span translateText="class.details"></span>
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <div class="details-grid">
          <!-- Fecha y hora -->
          <div class="detail-item">
            <mat-icon>schedule</mat-icon>
            <div class="detail-content">
              <div class="detail-label" translateText="class.info.startTime"></div>
              <div class="detail-value">{{ formatDateTime(getClassDateTime()) }}</div>
            </div>
          </div>
          
          <!-- Hora de finalización -->
          <div class="detail-item">
            <mat-icon>schedule</mat-icon>
            <div class="detail-content">
              <div class="detail-label" translateText="class.info.endTime"></div>
              <div class="detail-value">{{ formatDateTime(getEndTime()) }}</div>
            </div>
          </div>
          
          <!-- Duración -->
          <div class="detail-item">
            <mat-icon>timer</mat-icon>
            <div class="detail-content">
              <div class="detail-label" translateText="class.info.duration"></div>
              <div class="detail-value">{{ formatDuration() }}</div>
            </div>
          </div>
          
          <!-- Modalidad -->
          <div class="detail-item">
            <mat-icon>{{ getModalityIcon() }}</mat-icon>
            <div class="detail-content">
              <div class="detail-label" translateText="class.info.modality"></div>
              <div class="detail-value">
                {{ i18nService.translate('class.modality.' + classData()?.modality) }}
              </div>
            </div>
          </div>
          
          <!-- Ubicación o videollamada -->
          <div class="detail-item" *ngIf="classData()?.location || classData()?.video_call_link">
            <mat-icon>{{ classData()?.location ? 'location_on' : 'video_call' }}</mat-icon>
            <div class="detail-content">
              <div class="detail-label">
                {{ classData()?.location ? 
                   i18nService.translate('class.info.location') : 
                   i18nService.translate('class.info.videoCall') }}
              </div>
              <div class="detail-value">
                <span *ngIf="classData()?.location">{{ classData()?.location }}</span>
                <span *ngIf="classData()?.video_call_link">{{ getVideoCallPlatform() }}</span>
                <button 
                  *ngIf="classData()?.location" 
                  mat-icon-button 
                  (click)="openInMap()"
                  [matTooltip]="i18nService.translate('class.actions.openMap')">
                  <mat-icon>map</mat-icon>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Zona horaria -->
          <div class="detail-item" *ngIf="classData()?.timezone">
            <mat-icon>public</mat-icon>
            <div class="detail-content">
              <div class="detail-label" translateText="class.info.timezone"></div>
              <div class="detail-value">{{ classData()?.timezone }}</div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Card de descripción y notas -->
    <mat-card class="notes-card" *ngIf="classData()?.notes">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>description</mat-icon>
          <span translateText="common.notes"></span>
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <p class="notes-content">{{ classData()?.notes }}</p>
      </mat-card-content>
    </mat-card>

    <!-- Card de estudiantes -->
    <mat-card class="students-card" *ngIf="classData()?.students?.length">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>group</mat-icon>
          <span translateText="class.students.title"></span>
          <mat-chip>{{ classData()?.students?.length }}</mat-chip>
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <div class="students-list">
          <div class="student-item" *ngFor="let student of classData()?.students">
            <div class="student-avatar">
              <mat-icon>person</mat-icon>
            </div>
            <div class="student-info">
              <div class="student-name">{{ student.name }}</div>
              <div class="student-details">
                {{ student.age }} {{ i18nService.translate('class.students.age') }}
                <span *ngIf="student.level_group"> • {{ student.level_group }}</span>
              </div>
            </div>
            <div class="student-actions">
              <button mat-icon-button [matTooltip]="i18nService.translate('class.actions.contact')">
                <mat-icon>chat</mat-icon>
              </button>
              <button mat-icon-button [matTooltip]="i18nService.translate('class.actions.viewProfile')">
                <mat-icon>person</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Card de materiales y recursos -->
    <mat-card class="materials-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>folder</mat-icon>
          <span translateText="class.materials.title"></span>
        </mat-card-title>
        <mat-card-subtitle>
          <button mat-button color="primary" (click)="uploadMaterial()">
            <mat-icon>upload</mat-icon>
            <span translateText="class.materials.upload"></span>
          </button>
        </mat-card-subtitle>
      </mat-card-header>
      
      <mat-card-content>
        <div class="materials-placeholder">
          <mat-icon>folder_open</mat-icon>
          <p>No hay materiales disponibles aún</p>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Card de feedback (solo si la clase está completada) -->
    <mat-card class="feedback-card" *ngIf="classData()?.status === 'completed'">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>star</mat-icon>
          <span translateText="class.feedback.title"></span>
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <div class="feedback-placeholder">
          <mat-icon>rate_review</mat-icon>
          <p>Evaluación pendiente</p>
          <button mat-raised-button color="primary">
            <mat-icon>open_in_new</mat-icon>
            <span translateText="class.feedback.survey"></span>
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Sidebar (derecha/abajo en mobile) -->
  <div class="sidebar">
    
    <!-- Card del tutor -->
    <mat-card class="tutor-card">
      <mat-card-header>
        <div mat-card-avatar class="tutor-avatar">
          <mat-icon>person</mat-icon>
        </div>
        <mat-card-title>{{ classData()?.tutorData?.full_name || classData()?.tutorUser?.email }}</mat-card-title>
        <mat-card-subtitle translateText="class.tutor.title"></mat-card-subtitle>
      </mat-card-header>
      
      <mat-card-content>
        <div class="tutor-info">
          <!-- Bio breve -->
          <p class="tutor-bio" *ngIf="classData()?.tutorData?.bio">
            {{ classData()?.tutorData?.bio?.substring(0, 150) }}{{ classData()?.tutorData?.bio!.length > 150 ? '...' : '' }}
          </p>
          
          <!-- Idiomas -->
          <div class="tutor-languages" *ngIf="classData()?.tutorData?.birth_language">
            <mat-icon>language</mat-icon>
            <span>{{ classData()?.tutorData?.birth_language }}</span>
          </div>
          
          <!-- Experiencia -->
          <div class="tutor-experience" *ngIf="classData()?.tutorData?.experience_level">
            <mat-icon>school</mat-icon>
            <span>{{ i18nService.translate('experienceLevels.' + classData()?.tutorData?.experience_level) }}</span>
          </div>
        </div>
      </mat-card-content>
      
      <mat-card-actions>
        <button mat-button (click)="contactTutor()">
          <mat-icon>chat</mat-icon>
          <span translateText="class.actions.contact"></span>
        </button>
        <button mat-button (click)="viewTutorProfile()">
          <mat-icon>person</mat-icon>
          <span translateText="class.actions.viewProfile"></span>
        </button>
      </mat-card-actions>
    </mat-card>

    <!-- Card de información de facturación -->
    <mat-card class="billing-card" *ngIf="classData()?.hourly_rate">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>payment</mat-icon>
          <span translateText="class.billing.title"></span>
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <div class="billing-info">
          <div class="billing-item">
            <span class="billing-label" translateText="class.billing.hourlyRate"></span>
            <span class="billing-value">
              {{ classData()?.hourly_rate }} {{ classData()?.currency || 'USD' }}
            </span>
          </div>
          
          <div class="billing-item total">
            <span class="billing-label" translateText="class.billing.total"></span>
            <span class="billing-value">
              {{ ((classData()?.hourly_rate || 0) * ((classData()?.duration_minutes || 0) / 60)).toFixed(2) }} 
              {{ classData()?.currency || 'USD' }}
            </span>
          </div>
          
          <div class="billing-status">
            <mat-chip color="warn">{{ i18nService.translate('class.billing.pending') }}</mat-chip>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Card de acciones rápidas -->
    <mat-card class="quick-actions-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>flash_on</mat-icon>
          Acciones rápidas
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <div class="quick-actions">
          <button mat-stroked-button (click)="setReminder()" class="action-button">
            <mat-icon>notifications</mat-icon>
            <span translateText="class.actions.reminder"></span>
          </button>
          
          <button mat-stroked-button (click)="reportIncident()" class="action-button">
            <mat-icon>flag</mat-icon>
            <span translateText="class.actions.report"></span>
          </button>
          
          <button mat-stroked-button (click)="requestRecording()" class="action-button">
            <mat-icon>videocam</mat-icon>
            <span translateText="class.actions.requestRecording"></span>
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Card de historial -->
    <mat-card class="history-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>history</mat-icon>
          <span translateText="class.history.title"></span>
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <div class="history-timeline">
          <div class="history-item">
            <div class="history-icon">
              <mat-icon>add</mat-icon>
            </div>
            <div class="history-content">
              <div class="history-action">{{ i18nService.translate('class.history.created') }}</div>
              <div class="history-time">{{ formatDateTime(classData()?.created_at) }}</div>
            </div>
          </div>
          
          <div class="history-item" *ngIf="classData()?.updated_at">
            <div class="history-icon">
              <mat-icon>edit</mat-icon>
            </div>
            <div class="history-content">
              <div class="history-action">{{ i18nService.translate('class.history.edited') }}</div>
              <div class="history-time">{{ formatDateTime(classData()?.updated_at) }}</div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
